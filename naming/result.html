<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="작명소 - 사주 기반 이름 추천 결과. 부족한 기운을 보완해주는 이름을 추천합니다.">
  <title>작명소 - 이름 추천 결과</title>
  <!-- OG: 링크 공유 시 미리보기 -->
  <meta property="og:title" content="작명소 - 사주 기반 이름 추천">
  <meta property="og:description" content="부족한 기운을 보완해주는 이름을 추천해 드립니다.">
  <meta property="og:type" content="website">
  <link rel="stylesheet" href="style.css">
</head>
<body class="naming-page naming-result-page">
  <div class="naming-container">
    <header class="naming-header">
      <h1>이름 추천 결과</h1>
      <p>아래 추천을 참고하고 결과를 공유해 보세요. <a href="./dict.html" class="dict-link-inline">용어 사전</a></p>
    </header>

    <main class="naming-main">
      <div id="error-area"></div>
      <div id="loading-area" class="loading-area">
        <p>이름을 분석하고 있습니다...</p>
      </div>
      <div id="result-area" class="result-area" hidden>
        <!-- 성 한자 추천 -->
        <div class="surname-hanja-result" id="surname-hanja-result" hidden></div>

        <!-- 공유 바 -->
        <div class="share-bar">
          <span class="share-bar__label">이 결과 공유하기</span>
          <div class="share-btns">
            <button type="button" class="btn-share" id="btn-copy-link" title="링크 복사">링크 복사</button>
            <button type="button" class="btn-share" id="btn-native-share" title="공유" style="display:none">공유</button>
          </div>
        </div>

        <!-- 사주 오행 요약 -->
        <section class="result-section" id="ohang-section">
          <h2><a href="./dict.html#ohang" class="dict-link-inline">오행</a> 분석</h2>
          <p class="section-desc"><a href="./dict.html#naming-usage" class="dict-link-inline">부족한 기운</a>을 이름으로 보완할 수 있습니다.</p>
          <div class="ohang-chart" id="ohang-chart"></div>
          <p class="deficient-desc" id="deficient-desc"></p>
        </section>

        <!-- 음별 한자 찾기 (형제자매 공통 글자용) -->
        <section class="result-section" id="hanja-by-reading-section" hidden>
          <h2>음별 한자</h2>
          <p class="section-desc">해당 음의 한자 중 사주에 맞는 글자입니다.</p>
          <div id="hanja-by-reading-list"></div>
        </section>

        <!-- 추천 이름 목록 -->
        <section class="result-section" id="recommendations-section">
          <h2>추천 이름</h2>
          <div id="recommendations-list"></div>
        </section>
      </div>
    </main>

    <footer class="naming-footer">
      <div class="footer-buttons">
        <a href="../index.html" class="btn-footer btn-main">메인</a>
        <a href="index.html" class="btn-footer btn-retry">다시 입력</a>
      </div>
    </footer>
  </div>

  <!-- 사주 계산기 (기존 사주 페이지 로직 활용) -->
  <script src="../saju/js/sajuCalculator.js"></script>
  <script src="naming.js"></script>
  <script>
    (function() {
      'use strict';

      var params = NamingService.parseParams();
      var errorArea = document.getElementById('error-area');
      var loadingArea = document.getElementById('loading-area');
      var resultArea = document.getElementById('result-area');

      // 필수 파라미터 검증
      if (!params.surname || !params.birth || params.hour === null || params.hour === '') {
        showError('성을 입력하고 생년월일·출생시간을 선택해 주세요. 입력 페이지로 이동합니다.');
        setTimeout(function() { location.href = 'index.html'; }, 2500);
        return;
      }

      function showError(msg) {
        loadingArea.style.display = 'none';
        errorArea.innerHTML = '<div class="error-message" role="alert">' + escapeHtml(msg) + '</div>';
      }

      function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      var ELEMENT_IDS = { '목': 'mok', '화': 'hwa', '토': 'to', '금': 'geum', '수': 'su' };
      function makeDictLink(element) {
        var id = ELEMENT_IDS[element] || 'to';
        var colorClass = NamingService.OHANG_COLORS[element] || 'ohang-to';
        return '<a href="./dict.html#ohang-' + id + '" class="dict-link ' + colorClass + '">' + element + '</a>';
      }
      function wrapElementsWithDictLinks(text) {
        return text.replace(/(목|화|토|금|수)/g, function(m) { return makeDictLink(m); });
      }

      // 사주 계산
      var saju;
      try {
        saju = SajuCalculator.calculate(params.birth, parseInt(params.hour, 10), params.gender, params.min);
      } catch (e) {
        showError('잘못된 입력입니다. 입력 페이지에서 다시 확인해 주세요.');
        return;
      }

      // 한자 로드 및 추천 생성
      NamingService.loadHanjaXml().then(function(hanjaArray) {
        loadingArea.style.display = 'none';
        resultArea.hidden = false;

        var deficientElements = NamingService.getDeficientElements(saju.ohangCount);
        var pillars = [saju.year, saju.month, saju.day, saju.hour];
        var yinYang = { yang: 0, yin: 0 };
        pillars.forEach(function(p) {
          if (p.yinyang === '양') yinYang.yang++;
          else yinYang.yin++;
        });

        var recommendations = NamingService.getRecommendations(
          hanjaArray,
          params.surname,
          deficientElements,
          yinYang,
          params.name1 || undefined,
          params.name2 || undefined
        );

        // 오행 그래프 렌더링
        renderOhangChart(saju.ohangCount, deficientElements);

        // 부족한 오행 설명 (용어 링크 포함)
        var deficientDescEl = document.getElementById('deficient-desc');
        if (deficientElements.length > 0) {
          var deficientLinks = deficientElements.map(function(e) { return makeDictLink(e); }).join(', ');
          deficientDescEl.innerHTML = '부족한 기운: ' + deficientLinks + '. 아래 추천 이름이 이 기운을 보완해 드립니다.';
        } else {
          deficientDescEl.innerHTML = '오행이 고르게 분포되어 있습니다. <a href="./dict.html#ohang" class="dict-link-inline">균형 잡힌 이름</a>을 추천합니다.';
        }

        // 추천 이름 렌더링
        renderRecommendations(recommendations);

        // 음별 한자 찾기 (name1/name2 입력 시)
        renderHanjaByReading(hanjaArray, params.name1, params.name2, deficientElements);

        // 공유 기능 초기화
        initShareButtons(params);

        // 성 한자 추천 표시
        renderSurnameHanja(params.surname);

      }).catch(function(err) {
        showError('한자 데이터를 불러오는 데 실패했습니다. 잠시 후 다시 시도해 주세요.');
        console.error(err);
      });

      /**
       * 오행 막대 그래프 렌더링
       */
      function renderOhangChart(ohangCount, deficientElements) {
        var elements = ['목', '화', '토', '금', '수'];
        var maxCount = Math.max.apply(null, elements.map(function(e) { return ohangCount[e] || 0; })) || 1;
        var container = document.getElementById('ohang-chart');
        var html = '';

        elements.forEach(function(e) {
          var count = ohangCount[e] || 0;
          var pct = maxCount > 0 ? (count / maxCount) * 100 : 0;
          var isDeficient = deficientElements.indexOf(e) !== -1;
          var colorClass = NamingService.OHANG_COLORS[e] || 'ohang-to';
          var id = ELEMENT_IDS[e] || 'to';
          html += '<div class="ohang-bar">';
          html += '<label class="' + colorClass + '"><a href="./dict.html#ohang-' + id + '" class="dict-link">' + e + '</a></label>';
          html += '<div class="bar-track"><div class="bar-fill ' + colorClass + (isDeficient ? ' deficient' : '') + '" style="width:' + pct + '%"></div></div>';
          html += '<span class="bar-value">' + count + '</span>';
          html += '</div>';
        });

        container.innerHTML = html;
      }

      /**
       * 음별 한자 찾기 섹션 렌더링
       * (형제자매가 같은 글자를 쓰고 싶을 때 활용)
       */
      function renderHanjaByReading(hanjaArray, name1, name2, deficientElements) {
        var section = document.getElementById('hanja-by-reading-section');
        var container = document.getElementById('hanja-by-reading-list');
        var readings = [];
        if (name1) readings.push({ input: name1, label: '첫 글자' });
        if (name2 && name2 !== name1) readings.push({ input: name2, label: '둘째 글자' });

        if (readings.length === 0) {
          section.hidden = true;
          return;
        }

        var html = '';
        readings.forEach(function(r) {
          var items = NamingService.getHanjaByReading(hanjaArray, r.input, deficientElements);
          if (items.length === 0) return;

          html += '<div class="hanja-reading-block">';
          html += '<h3 class="hanja-reading-title">『' + escapeHtml(r.input) + '』 음의 한자 (사주 오행 맞춤 순)</h3>';
          html += '<ul class="hanja-reading-list">';
          items.forEach(function(item) {
            var h = item.hanja;
            var colorClass = NamingService.OHANG_COLORS[h.element] || 'ohang-to';
            html += '<li class="hanja-reading-item">';
            html += '<span class="hanja-reading-char ' + colorClass + '">' + escapeHtml(h.char) + '</span>';
            html += '<div class="hanja-reading-info"><span class="hanja-reading-reading">' + escapeHtml(h.reading) + '</span><span class="hanja-reading-meaning">' + escapeHtml(h.meaning) + '</span><em class="' + colorClass + '">' + wrapElementsWithDictLinks(escapeHtml(item.fitReason)) + '</em></div>';
            html += '</li>';
          });
          html += '</ul></div>';
        });

        if (html) {
          container.innerHTML = html;
          section.hidden = false;
        } else {
          section.hidden = true;
        }
      }

      /**
       * 추천 이름 카드 렌더링
       */
      function renderRecommendations(recommendations) {
        var container = document.getElementById('recommendations-list');
        if (!recommendations || recommendations.length === 0) {
          container.innerHTML = '<p class="no-results">조건에 맞는 추천 이름이 없습니다. 이름 첫/둘째 글자 조건을 바꿔 보세요.</p>';
          return;
        }

        var html = '';
        recommendations.forEach(function(r, idx) {
          var h1 = r.hanja1;
          var h2 = r.hanja2;
          var color1 = NamingService.OHANG_COLORS[h1.element] || 'ohang-to';
          var color2 = NamingService.OHANG_COLORS[h2.element] || 'ohang-to';
          html += '<article class="recommendation-card">';
          html += '<h3 class="rec-name">' + escapeHtml(r.fullName) + '</h3>';
          html += '<div class="rec-hanja-row">';
          html += '<div class="rec-hanja-item"><span class="rec-char ' + color1 + '">' + escapeHtml(h1.char) + '</span><span class="rec-reading">' + escapeHtml(h1.reading) + '</span><span class="rec-meaning">' + escapeHtml(h1.meaning) + '</span></div>';
          html += '<div class="rec-hanja-item"><span class="rec-char ' + color2 + '">' + escapeHtml(h2.char) + '</span><span class="rec-reading">' + escapeHtml(h2.reading) + '</span><span class="rec-meaning">' + escapeHtml(h2.meaning) + '</span></div>';
          html += '</div>';
          html += '<p class="rec-explanation">' + wrapElementsWithDictLinks(escapeHtml(r.explanation)) + '</p>';
          html += '<p class="rec-score">점수: ' + r.score + '점</p>';
          html += '</article>';
        });

        container.innerHTML = html;
      }

      /**
       * 공유 버튼: 링크 복사, Web Share API(모바일)
       */
      function initShareButtons(params) {
        var shareUrl = location.href;
        var shareTitle = '작명소 - 이름 추천 결과';
        var shareText = params.surname + '씨의 사주에 맞는 이름을 추천받았어요.';

        // 링크 복사
        var btnCopy = document.getElementById('btn-copy-link');
        if (btnCopy) {
          btnCopy.addEventListener('click', function() {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(shareUrl).then(function() {
                showCopiedFeedback(btnCopy);
              }).catch(function() {
                fallbackCopy(shareUrl, btnCopy);
              });
            } else {
              fallbackCopy(shareUrl, btnCopy);
            }
          });
        }

        // Web Share API (모바일에서 네이티브 공유 시트)
        var btnShare = document.getElementById('btn-native-share');
        if (btnShare && navigator.share) {
          btnShare.style.display = 'inline-flex';
          btnShare.addEventListener('click', function() {
            navigator.share({
              title: shareTitle,
              text: shareText,
              url: shareUrl
            }).catch(function() {});
          });
        }
      }

      function fallbackCopy(text, btn) {
        var ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand('copy');
          showCopiedFeedback(btn);
        } catch (e) {}
        document.body.removeChild(ta);
      }

      function renderSurnameHanja(surname) {
        var container = document.getElementById('surname-hanja-result');
        if (!container || !surname) return;
        NamingService.loadSurnameXml().then(function(map) {
          var list = NamingService.getSurnameHanja(map, surname.trim());
          if (!list || list.length === 0) return;
          var html = '<span class="surname-hanja-label">' + escapeHtml(surname) + '씨 성 한자: </span>';
          html += list.map(function(item) {
            return '<span class="surname-hanja-item"><span class="surname-hanja-char">' + escapeHtml(item.char) + '</span><span class="surname-hanja-meaning">(' + escapeHtml(item.meaning) + ')</span></span>';
          }).join(', ');
          container.innerHTML = html;
          container.hidden = false;
        }).catch(function() {});
      }

      function showCopiedFeedback(btn) {
        if (!btn) return;
        var orig = btn.textContent;
        btn.textContent = '복사됨';
        btn.classList.add('copied');
        setTimeout(function() {
          btn.textContent = orig;
          btn.classList.remove('copied');
        }, 2000);
      }
    })();
  </script>
</body>
</html>
