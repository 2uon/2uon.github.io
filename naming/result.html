<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="작명소 - 사주 기반 이름 추천 결과. 부족한 기운을 보완해주는 이름을 추천합니다.">
  <title>작명소 - 이름 추천 결과</title>
  <!-- OG: 링크 공유 시 미리보기 -->
  <meta property="og:title" content="작명소 - 사주 기반 이름 추천">
  <meta property="og:description" content="부족한 기운을 보완해주는 이름을 추천해 드립니다.">
  <meta property="og:type" content="website">
  <link rel="stylesheet" href="style.css">
</head>
<body class="naming-page naming-result-page">
  <div class="naming-container">
    <header class="naming-header">
      <h1>이름 추천 결과</h1>
      <p>아래 추천을 참고하고 결과를 공유해 보세요.</p>
    </header>

    <main class="naming-main">
      <div id="error-area"></div>
      <div id="loading-area" class="loading-area">
        <p>이름을 분석하고 있습니다...</p>
      </div>
      <div id="result-area" class="result-area" hidden>
        <!-- 성 한자 추천 -->
        <div class="surname-hanja-result" id="surname-hanja-result" hidden></div>

        <!-- 사주 오행 요약 -->
        <section class="result-section" id="ohang-section">
          <h2 class="result-section-title">
            <a href="./dict.html#ohang" class="dict-link">오행</a> 분석
            <button type="button" class="info-btn" data-info-key="ohang" aria-label="오행 설명 보기" title="설명">ⓘ</button>
          </h2>
          <p class="section-desc">부족한 기운을 이름으로 보완할 수 있습니다.</p>
          <div class="ohang-chart" id="ohang-chart"></div>
          <div class="ohang-need-table-wrap" id="ohang-need-table-wrap">
            <table class="ohang-need-table" id="ohang-need-table" aria-label="필요한 기운 요약">
              <thead>
                <tr>
                  <th scope="col">필요한 기운</th>
                  <th scope="col">보강하면 좋은 기운</th>
                  <th scope="col">없어야 좋은 기운</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td id="cell-needed"></td>
                  <td id="cell-supplement"></td>
                  <td id="cell-excess"></td>
                </tr>
              </tbody>
            </table>
          </div>
          <p class="deficient-desc" id="deficient-desc"></p>
          <div class="ohang-detail-toggle-wrap" id="ohang-detail-toggle-wrap">
            <button type="button" class="toggle-btn" id="toggle-detail-btn" aria-expanded="false">
              <span class="toggle-label">상세 분석 보기 (오행 비율 · 합충형파해 · 십성)</span>
              <span class="toggle-icon" aria-hidden="true">▼</span>
            </button>
            <div class="ohang-detail-content" id="ohang-detail-content" hidden>
              <div id="ohang-detail-body"></div>
            </div>
          </div>
        </section>

        <!-- 음별 한자 찾기 (형제자매 공통 글자용) -->
        <section class="result-section" id="hanja-by-reading-section" hidden>
          <h2>음별 한자</h2>
          <p class="section-desc">해당 음의 한자 중 사주에 맞는 글자입니다.</p>
          <div id="hanja-by-reading-list"></div>
        </section>

        <!-- 추천 이름 목록 -->
        <section class="result-section" id="recommendations-section">
          <h2>추천 이름</h2>
          <div id="recommendations-list"></div>
        </section>
      </div>
    </main>

    <footer class="naming-footer">
      <div class="footer-buttons">
        <a href="index.html" class="btn-footer btn-retry">다시하기</a>
        <button type="button" class="btn-footer btn-share" id="btn-share-footer">공유하기</button>
      </div>
      <p class="footer-disclaimer">결과 및 점수는 객관적인 기준이 아닌 알고리즘을 통한 주관적 계산입니다.</p>
    </footer>
  </div>

  <!-- 사주 계산기 (기존 사주 페이지 로직 활용) -->
  <script src="../saju/js/sajuCalculator.js"></script>
  <script src="naming.js"></script>
  <script>
    (function() {
      'use strict';

      var params = NamingService.parseParams();
      var errorArea = document.getElementById('error-area');
      var loadingArea = document.getElementById('loading-area');
      var resultArea = document.getElementById('result-area');

      // 필수 파라미터 검증
      if (!params.surname || !params.birth || params.hour === null || params.hour === '') {
        showError('성을 입력하고 생년월일·출생시간을 선택해 주세요. 입력 페이지로 이동합니다.');
        setTimeout(function() { location.href = 'index.html'; }, 2500);
        return;
      }

      function showError(msg) {
        loadingArea.style.display = 'none';
        errorArea.innerHTML = '<div class="error-message" role="alert">' + escapeHtml(msg) + '</div>';
      }

      function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      var INFO_TEXTS = {
        ohang: { what: '오행 (五行)', desc: '목·화·토·금·수 다섯 원소. 사주에 부족한 오행을 이름에 담아 보완하는 것이 작명의 핵심입니다.', criteria: '오행 비율·합·충·형·파·해·십성을 종합하여 필요한 오행을 계산합니다. 沖에서 손상된 오행, 일주 강약·관살 균형에 따른 식상·인비 오행, 충돌 시 土 조화 등을 반영합니다. 추천 이름에는 필요한 오행 한자를 우선 배치합니다.' },
        namingUsage: { what: '부족한 기운 보완', desc: '사주에 부족한 오행이 있으면, 그 오행을 가진 한자를 이름에 넣어 기운을 보완합니다.', criteria: '점수 비율: 세대 20 : 성별 15 : 발음 10 : 오행 7 : 획수 5 : 서열 2 (비율 기준, 만점 100점)' }
      };

      function showInfoModal(key) {
        var info = INFO_TEXTS[key];
        if (!info) return;
        var overlay = document.createElement('div');
        overlay.className = 'info-modal-overlay';
        overlay.innerHTML = '<div class="info-modal" role="dialog" aria-labelledby="info-modal-title">' +
          '<div class="info-modal-header">' +
          '<h4 id="info-modal-title">' + escapeHtml(info.what) + '</h4>' +
          '<button type="button" class="info-modal-close" aria-label="닫기">&times;</button>' +
          '</div>' +
          '<div class="info-modal-body">' +
          '<p><strong>이 항목은?</strong><br>' + escapeHtml(info.desc) + '</p>' +
          '<p><strong>추천 기준</strong><br>' + escapeHtml(info.criteria) + '</p>' +
          '<p><a href="./dict.html#ohang" class="dict-link-inline">용어 사전에서 자세히 보기</a></p>' +
          '</div></div>';
        function closeModal() {
          overlay.remove();
          document.removeEventListener('keydown', onKey);
        }
        function onKey(e) { if (e.key === 'Escape') closeModal(); }
        overlay.addEventListener('click', function(e) {
          if (e.target === overlay || e.target.classList.contains('info-modal-close')) closeModal();
        });
        document.addEventListener('keydown', onKey);
        document.body.appendChild(overlay);
      }

      function attachInfoButtons() {
        document.querySelectorAll('.info-btn[data-info-key]').forEach(function(btn) {
          btn.addEventListener('click', function() { showInfoModal(btn.getAttribute('data-info-key')); });
        });
      }

      // 사주 계산
      var saju;
      try {
        saju = SajuCalculator.calculate(params.birth, parseInt(params.hour, 10), params.gender, params.min);
      } catch (e) {
        showError('잘못된 입력입니다. 입력 페이지에서 다시 확인해 주세요.');
        return;
      }

      // 한자 로드 및 추천 생성
      NamingService.loadHanjaXml().then(function(hanjaArray) {
        loadingArea.style.display = 'none';
        resultArea.hidden = false;

        var deficientResult = NamingService.getDeficientElements(saju);
        var deficientElements = deficientResult.elements || [];
        var deficientReasons = deficientResult.reasons || [];
        var supplementGood = deficientResult.supplementGood || [];
        var excess = deficientResult.excess || [];
        var ohangDetail = deficientResult.detail || { ratio: [], hapChung: [], sipseong: [] };
        var pillars = [saju.year, saju.month, saju.day, saju.hour];
        var yinYang = { yang: 0, yin: 0 };
        pillars.forEach(function(p) {
          if (p.yinyang === '양') yinYang.yang++;
          else yinYang.yin++;
        });

        var birthYear = params.birth ? parseInt(params.birth.split('-')[0], 10) : null;
        var birthOrder = params.birthOrder || undefined;
        var recommendations = NamingService.getRecommendations(
          hanjaArray,
          params.surname,
          deficientElements,
          yinYang,
          params.name1 || undefined,
          params.name2 || undefined,
          params.gender || undefined,
          birthYear || undefined,
          birthOrder
        );

        // 오행 그래프 렌더링
        renderOhangChart(saju.ohangCount, deficientElements);

        // 오행 요약 표: 필요한 기운 · 보강하면 좋은 기운 · 없어야 좋은 기운
        var cellNeeded = document.getElementById('cell-needed');
        var cellSupplement = document.getElementById('cell-supplement');
        var cellExcess = document.getElementById('cell-excess');
        var OHANG_COLORS = NamingService.OHANG_COLORS || {};
        function fmtOhangList(arr) {
          if (!arr || arr.length === 0) return '—';
          return arr.map(function(e) {
            var cls = OHANG_COLORS[e] || '';
            return '<span class="ohang-tag ' + cls + '">' + escapeHtml(e) + '</span>';
          }).join(' ');
        }
        if (cellNeeded) cellNeeded.innerHTML = fmtOhangList(deficientElements);
        if (cellSupplement) cellSupplement.innerHTML = fmtOhangList(supplementGood);
        if (cellExcess) cellExcess.innerHTML = fmtOhangList(excess);

        // 부족한 오행 설명 (요약)
        var deficientDescEl = document.getElementById('deficient-desc');
        if (deficientElements.length > 0) {
          deficientDescEl.textContent = '아래 추천 이름은 필요한 기운을 보완하도록 선정했습니다.';
        } else {
          deficientDescEl.textContent = '오행이 고르게 분포되어 있습니다. 균형 잡힌 이름을 추천합니다.';
        }

        // 상세 분석(오행 비율 · 합충형파해 · 십성) 토글 — 항상 표시
        var detailWrap = document.getElementById('ohang-detail-toggle-wrap');
        var toggleBtn = document.getElementById('toggle-detail-btn');
        var detailContent = document.getElementById('ohang-detail-content');
        var detailBody = document.getElementById('ohang-detail-body');
        if (detailWrap) detailWrap.style.display = '';
        if (detailBody) {
          var parts = [];
          if (ohangDetail.ratio && ohangDetail.ratio.length > 0) {
            parts.push('<p class="detail-row"><strong>오행 비율</strong>: 사주에서 가장 적은 기운 → ' + escapeHtml(ohangDetail.ratio.join(', ')) + '</p>');
          }
          if (ohangDetail.hapChung && ohangDetail.hapChung.length > 0) {
            parts.push('<p class="detail-row"><strong>합·충·형·파·해</strong>: 沖·刑·破·害로 손상된 기운 보완 → ' + escapeHtml(ohangDetail.hapChung.join(', ')) + '</p>');
          }
          if (ohangDetail.sipseong && ohangDetail.sipseong.length > 0) {
            parts.push('<p class="detail-row"><strong>십성</strong>: 일주 강약·관살·식상 균형에 따른 보완 → ' + escapeHtml(ohangDetail.sipseong.join(', ')) + '</p>');
          }
          if (parts.length === 0) {
            parts.push('<p class="detail-row">분석 근거: ' + escapeHtml(deficientReasons.join(', ')) + '를 반영했습니다.</p>');
          }
          detailBody.innerHTML = parts.join('');
        }
        if (toggleBtn && detailContent) {
          toggleBtn.addEventListener('click', function() {
            var expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
            toggleBtn.setAttribute('aria-expanded', !expanded);
            toggleBtn.querySelector('.toggle-label').textContent = expanded ? '상세 분석 보기 (오행 비율 · 합충형파해 · 십성)' : '상세 분석 접기';
            toggleBtn.querySelector('.toggle-icon').textContent = expanded ? '▼' : '▲';
            detailContent.hidden = expanded;
          });
        }

        // 추천 이름 렌더링
        renderRecommendations(recommendations);

        // 음별 한자 찾기 (name1/name2 입력 시)
        renderHanjaByReading(hanjaArray, params.name1, params.name2, deficientElements);

        // 공유 기능 초기화
        initShareButtons(params);

        // 성 한자 추천 표시 (선택한 성 한자 있으면 강조)
        renderSurnameHanja(params.surname, params.surnameHanja);

        // info-btn 클릭 모달 연결
        attachInfoButtons();

      }).catch(function(err) {
        showError('한자 데이터를 불러오는 데 실패했습니다. 잠시 후 다시 시도해 주세요.');
        console.error(err);
      });

      /**
       * 오행 막대 그래프 렌더링
       */
      function renderOhangChart(ohangCount, deficientElements) {
        var elements = ['목', '화', '토', '금', '수'];
        var maxCount = Math.max.apply(null, elements.map(function(e) { return ohangCount[e] || 0; })) || 1;
        var container = document.getElementById('ohang-chart');
        var html = '';

        elements.forEach(function(e) {
          var count = ohangCount[e] || 0;
          var pct = maxCount > 0 ? (count / maxCount) * 100 : 0;
          var isDeficient = deficientElements.indexOf(e) !== -1;
          var colorClass = NamingService.OHANG_COLORS[e] || 'ohang-to';
          html += '<div class="ohang-bar">';
          html += '<label class="' + colorClass + '">' + e + '</label>';
          html += '<div class="bar-track"><div class="bar-fill ' + colorClass + (isDeficient ? ' deficient' : '') + '" style="width:' + pct + '%"></div></div>';
          html += '<span class="bar-value">' + count + '</span>';
          html += '</div>';
        });

        container.innerHTML = html;
      }

      /**
       * 음별 한자 찾기 섹션 렌더링
       * (형제자매가 같은 글자를 쓰고 싶을 때 활용)
       */
      function renderHanjaByReading(hanjaArray, name1, name2, deficientElements) {
        var section = document.getElementById('hanja-by-reading-section');
        var container = document.getElementById('hanja-by-reading-list');
        var readings = [];
        if (name1) readings.push({ input: name1, label: '첫 글자' });
        if (name2 && name2 !== name1) readings.push({ input: name2, label: '둘째 글자' });

        if (readings.length === 0) {
          section.hidden = true;
          return;
        }

        var html = '';
        readings.forEach(function(r) {
          var items = NamingService.getHanjaByReading(hanjaArray, r.input, deficientElements);
          if (items.length === 0) return;

          html += '<div class="hanja-reading-block">';
          html += '<h3 class="hanja-reading-title">『' + escapeHtml(r.input) + '』 음의 한자 (사주 오행 맞춤 순)</h3>';
          html += '<ul class="hanja-reading-list">';
          items.forEach(function(item) {
            var h = item.hanja;
            var colorClass = NamingService.OHANG_COLORS[h.element] || 'ohang-to';
            html += '<li class="hanja-reading-item">';
            html += '<span class="hanja-reading-char ' + colorClass + '">' + escapeHtml(h.char) + '</span>';
            html += '<div class="hanja-reading-info"><span class="hanja-reading-reading">' + escapeHtml(h.reading) + '</span><span class="hanja-reading-meaning">' + escapeHtml(h.meaning) + '</span><em class="' + colorClass + '">' + escapeHtml(item.fitReason) + '</em></div>';
            html += '</li>';
          });
          html += '</ul></div>';
        });

        if (html) {
          container.innerHTML = html;
          section.hidden = false;
        } else {
          section.hidden = true;
        }
      }

      /**
       * 추천 이름 카드 렌더링
       */
      function renderRecommendations(recommendations) {
        var container = document.getElementById('recommendations-list');
        if (!recommendations || recommendations.length === 0) {
          container.innerHTML = '<p class="no-results">조건에 맞는 추천 이름이 없습니다. 이름 첫/둘째 글자 조건을 바꿔 보세요.</p>';
          return;
        }

        var html = '';
        recommendations.forEach(function(r, idx) {
          var h1 = r.hanja1;
          var h2 = r.hanja2;
          var color1 = NamingService.OHANG_COLORS[h1.element] || 'ohang-to';
          var color2 = NamingService.OHANG_COLORS[h2.element] || 'ohang-to';
          html += '<article class="recommendation-card">';
          html += '<h3 class="rec-name">' + escapeHtml(r.fullName) + '</h3>';
          html += '<div class="rec-hanja-row">';
          html += '<div class="rec-hanja-item"><span class="rec-char ' + color1 + '">' + escapeHtml(h1.char) + '</span><span class="rec-reading">' + escapeHtml(h1.reading) + '</span><span class="rec-meaning">' + escapeHtml(h1.meaning) + '</span></div>';
          html += '<div class="rec-hanja-item"><span class="rec-char ' + color2 + '">' + escapeHtml(h2.char) + '</span><span class="rec-reading">' + escapeHtml(h2.reading) + '</span><span class="rec-meaning">' + escapeHtml(h2.meaning) + '</span></div>';
          html += '</div>';
          html += '<p class="rec-explanation">' + escapeHtml(r.explanation) + '</p>';
          var scoreLine = '점수: ' + r.score + '점';
          if (r.pronunciationScore !== undefined) {
            scoreLine += ' (발음 ' + r.pronunciationScore + '/10)';
            if (r.pronunciationReason) scoreLine += ' · ' + escapeHtml(r.pronunciationReason);
          }
          html += '<p class="rec-score">' + scoreLine + '</p>';
          html += '</article>';
        });

        container.innerHTML = html;
      }

      /**
       * 공유 버튼: Web Share API(모바일) 또는 링크 복사
       */
      function initShareButtons(params) {
        var shareUrl = location.href;
        var shareTitle = '작명소 - 이름 추천 결과';
        var shareText = params.surname + '씨의 사주에 맞는 이름을 추천받았어요.';
        var btnShare = document.getElementById('btn-share-footer');

        if (btnShare) {
          btnShare.addEventListener('click', function() {
            if (navigator.share) {
              navigator.share({ title: shareTitle, text: shareText, url: shareUrl }).catch(function() {});
            } else {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(shareUrl).then(function() {
                  showCopiedFeedback(btnShare);
                }).catch(function() {
                  fallbackCopy(shareUrl, btnShare);
                });
              } else {
                fallbackCopy(shareUrl, btnShare);
              }
            }
          });
        }
      }

      function fallbackCopy(text, btn) {
        var ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand('copy');
          showCopiedFeedback(btn);
        } catch (e) {}
        document.body.removeChild(ta);
      }

      function renderSurnameHanja(surname, surnameHanja) {
        var container = document.getElementById('surname-hanja-result');
        if (!container || !surname) return;
        NamingService.loadSurnameXml().then(function(map) {
          var list = NamingService.getSurnameHanja(map, surname.trim());
          if (!list || list.length === 0) return;
          var selectedChar = (surnameHanja || '').trim();
          var selectedItem = list.filter(function(item) { return item.char === selectedChar; })[0];
          var html = '';
          if (selectedItem) {
            html += '<p class="surname-hanja-selected"><span class="surname-hanja-label">선택한 성 한자: </span>' +
              '<span class="surname-hanja-item selected"><span class="surname-hanja-char">' + escapeHtml(selectedItem.char) + '</span>' +
              '<span class="surname-hanja-meaning">(' + escapeHtml(selectedItem.meaning) + ')</span></span></p>';
          }
          html += '<p class="surname-hanja-all"><span class="surname-hanja-label">' + escapeHtml(surname) + '씨 성 한자: </span>';
          html += list.map(function(item) {
            var isSelected = item.char === selectedChar;
            return '<span class="surname-hanja-item' + (isSelected ? ' selected' : '') + '"><span class="surname-hanja-char">' + escapeHtml(item.char) + '</span><span class="surname-hanja-meaning">(' + escapeHtml(item.meaning) + ')</span></span>';
          }).join(', ') + '</p>';
          container.innerHTML = html;
          container.hidden = false;
        }).catch(function() {});
      }

      function showCopiedFeedback(btn) {
        if (!btn) return;
        var orig = btn.textContent;
        btn.textContent = '복사됨';
        btn.classList.add('copied');
        setTimeout(function() {
          btn.textContent = orig;
          btn.classList.remove('copied');
        }, 2000);
      }
    })();
  </script>
</body>
</html>
